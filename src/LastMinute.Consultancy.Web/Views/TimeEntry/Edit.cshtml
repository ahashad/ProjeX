@model LastMinute.Consultancy.Application.TimeEntry.Commands.UpdateTimeEntryCommand
@{
    ViewData["Title"] = "Edit Time Entry";
    var timeEntry = ViewBag.TimeEntryDetails as LastMinute.Consultancy.Application.TimeEntry.TimeEntryDto;
}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Edit Time Entry</h1>
    <div>
        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-sm btn-info shadow-sm">
            <i class="fas fa-eye fa-sm text-white-50"></i> View Details
        </a>
<a asp-action="Index" asp-route-actualAssignmentId="@Model.ActualAssignmentId" class="btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Time Entries
        </a>
    </div>
</div>

@if (timeEntry != null)
{
    <div class="row mb-3">
        <div class="col-12">
          <div class="card shadow">
  <div class="card-header py-2 bg-light">
       <div class="row">
        <div class="col-md-8">
       <h6 class="m-0 font-weight-bold text-primary">
           <i class="fas fa-project-diagram"></i> @timeEntry.ProjectName
           </h6>
      <small class="text-muted">Client: @timeEntry.ClientName | Employee: @timeEntry.EmployeeName | Role: @timeEntry.RoleName</small>
        </div>
            <div class="col-md-4 text-right">
     <span class="badge badge-@(timeEntry.Status.ToString().ToLower() switch { "draft" => "secondary", "submitted" => "warning", "approved" => "success", "rejected" => "danger", "invoiced" => "primary", _ => "secondary" })">
          @timeEntry.Status
            </span>
        </div>
     </div>
    </div>
     </div>
        </div>
  </div>
}

<div class="row">
    <div class="col-md-8">
        <div class="card shadow mb-4">
   <div class="card-header py-3">
 <h6 class="m-0 font-weight-bold text-primary">Edit Time Entry Details</h6>
      </div>
          <div class="card-body">
                <form asp-action="Edit" method="post" novalidate>
            <input asp-for="Id" type="hidden" />
             <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

          <div class="form-group">
         <label asp-for="ActualAssignmentId" class="control-label">Assignment</label>
      <select asp-for="ActualAssignmentId" asp-items="@ViewBag.ActualAssignmentId" class="form-control">
   <option value="">-- Select Assignment --</option>
   </select>
   <span asp-validation-for="ActualAssignmentId" class="text-danger"></span>
  <small class="form-text text-muted">You can change the assignment if needed.</small>
 </div>

         <div class="row">
           <div class="col-md-6">
           <div class="form-group">
       <label asp-for="Date" class="control-label">Date</label>
       <input asp-for="Date" class="form-control" type="date" />
     <span asp-validation-for="Date" class="text-danger"></span>
       </div>
         </div>
        <div class="col-md-6">
   <div class="form-group">
       <label asp-for="Hours" class="control-label">Hours</label>
     <input asp-for="Hours" class="form-control" type="number" step="0.25" min="0.25" max="24" />
           <span asp-validation-for="Hours" class="text-danger"></span>
            <small class="form-text text-muted">Enter hours in increments of 0.25 (15 minutes).</small>
    </div>
                  </div>
           </div>

    <div class="form-group">
     <label asp-for="Description" class="control-label">Description</label>
      <textarea asp-for="Description" class="form-control" rows="4" placeholder="Describe the work performed..."></textarea>
     <span asp-validation-for="Description" class="text-danger"></span>
            </div>

           <div class="row">
      <div class="col-md-6">
    <div class="form-group">
        <label asp-for="Status" class="control-label">Status</label>
    <select asp-for="Status" asp-items="@ViewBag.StatusOptions" class="form-control"></select>
          <span asp-validation-for="Status" class="text-danger"></span>
 <small class="form-text text-muted">Only draft entries can be edited by non-managers.</small>
   </div>
             </div>
               <div class="col-md-6">
   <div class="form-group">
      <div class="form-check mt-4">
             <input asp-for="IsBillable" class="form-check-input" type="checkbox" id="isBillable" />
                   <label asp-for="IsBillable" class="form-check-label" for="isBillable">
       Is this time billable to the client?
      </label>
   </div>
      <span asp-validation-for="IsBillable" class="text-danger"></span>
         </div>
           </div>
             </div>

    <div class="form-group" id="billableRateGroup">
     <label asp-for="BillableRate" class="control-label">Billable Rate (per hour)</label>
         <div class="input-group">
 <div class="input-group-prepend">
    <span class="input-group-text">$</span>
        </div>
    <input asp-for="BillableRate" class="form-control" type="number" step="0.01" min="0" placeholder="Leave empty for default rate" />
  </div>
<span asp-validation-for="BillableRate" class="text-danger"></span>
              <small class="form-text text-muted">Leave empty to use the default hourly rate.</small>
  </div>

 <div class="form-group">
          <button type="submit" class="btn btn-primary">
  <i class="fas fa-save"></i> Update Time Entry
       </button>
         <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info">
       <i class="fas fa-eye"></i> View Details
      </a>
    <a asp-action="Index" asp-route-actualAssignmentId="@Model.ActualAssignmentId" class="btn btn-secondary">
         <i class="fas fa-times"></i> Cancel
   </a>
  </div>
    </form>
 </div>
 </div>
 </div>

    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
       <h6 class="m-0 font-weight-bold text-warning">Edit Guidelines</h6>
 </div>
       <div class="card-body">
 <div class="mb-3">
        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Status Rules</h6>
      <ul class="small">
                <li><strong>Draft:</strong> Can be freely edited</li>
<li><strong>Submitted:</strong> Pending manager approval</li>
         <li><strong>Approved:</strong> Manager approved, ready for billing</li>
   <li><strong>Rejected:</strong> Needs revision, returned to draft</li>
            <li><strong>Invoiced:</strong> Already billed to client</li>
</ul>
  </div>
          
    <div class="mb-3">
            <h6><i class="fas fa-lock text-danger"></i> Edit Restrictions</h6>
      <ul class="small">
              <li>Only draft and rejected entries can be edited</li>
         <li>Managers can edit any non-invoiced entry</li>
 <li>Invoiced entries cannot be modified</li>
  </ul>
   </div>

         <div>
     <h6><i class="fas fa-clock text-info"></i> Time Tracking Tips</h6>
        <ul class="small">
      <li>Be accurate with your time logging</li>
           <li>Provide detailed descriptions</li>
   <li>Submit regularly for timely approvals</li>
   </ul>
 </div>
            </div>
      </div>

        @if (timeEntry != null && timeEntry.Status == LastMinute.Consultancy.Domain.Enums.TimeEntryStatus.Draft)
        {
 <div class="card shadow mb-4 border-left-success">
        <div class="card-header py-3 bg-success text-white">
     <h6 class="m-0 font-weight-bold">Quick Actions</h6>
      </div>
     <div class="card-body">
       <p class="small mb-3">Ready to submit this time entry for approval?</p>
      <form asp-action="Submit" asp-route-id="@Model.Id" asp-route-actualAssignmentId="@Model.ActualAssignmentId" method="post" class="d-inline">
 @Html.AntiForgeryToken()
      <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Submit this time entry for approval?')">
   <i class="fas fa-paper-plane"></i> Submit for Approval
       </button>
          </form>
            </div>
      </div>
    }
 </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
  $(document).ready(function() {
      // Toggle billable rate field based on checkbox
     function toggleBillableRate() {
       if ($('#isBillable').is(':checked')) {
      $('#billableRateGroup').show();
  } else {
         $('#billableRateGroup').hide();
    $('#BillableRate').val('');
 }
            }

     $('#isBillable').change(toggleBillableRate);
         toggleBillableRate(); // Initialize on page load
        });
  </script>
}